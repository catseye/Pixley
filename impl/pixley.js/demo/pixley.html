<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Pixley</title>
  <style>
#info { float: right; }
#program { display: none; }
#load { display: none; }
#step { display: none; }
#speed { display: none; }
#display {
    color: white;
    background: blue;
    border: 3px solid blue;
    font-family: monospace;
}
#output {
    color: white;
    background: #008000;
    border: 3px solid #008000;
    font-family: monospace;
}
#canvas { border: 1px solid blue; display: none; }
.example_program {
    display: none;
}
  </style>
</head>
<body>

<p id="info">
Pixley on:
<a href="http://catseye.tc/node/Pixley">catseye.tc</a> |
<a href="https://github.com/catseye/Pixley">github</a>
</p>

<h1>Pixley</h1>

<p><em>Note: this implementation uses Web Workers, and thus to avoid security
restrictions, this page must be served from a web server (rather than loaded
as a local file in your browser,) with <code>impl/pixley.js</code> as the
document root.</em></p>

<div id="edit_panel"></div>
<div id="panel">
  <button id="start">Start</button>
  <button id="stop">Stop</button>
  <button id="wrap" onclick="c.wrapWith(document.getElementById('pixley-interpreter').innerHTML);">Wrap in Pixley Interpreter</button>
  <span id="status"></span>
</div>

<div>
  example source: <select id="select_source"></select>
</div>

<div id="display_container">
  <div id="display"></div>
  <div id="output"></div>
  <canvas id="canvas">
    Your browser doesn't understand what a canvas is.
  </canvas>
</div>

<textarea id="program" rows="25" cols="40"></textarea>

<div id="cons-test" class="example_program"
>(cons (quote a) (cons (quote b) ())</div>

<div id="equality-test" class="example_program"
>(equal? (quote foo) (quote foo))</div>

<div id="list-test" class="example_program"
>(list? (quote foo))</div>

<div id="binding-test-1" class="example_program"
>(let* ((a (quote b)) (c (quote d))) (cons a (cons c ())))</div>

<div id="binding-test-2" class="example_program"
>(let* ((a (let* ((b (quote c))) b))) a)</div>

<div id="binding-test-3" class="example_program"
>(let* ((a (lambda (x y) (cons x (cons y ())))))
        (a (quote foo) (quote bar)))</div>

<div id="cond-test-1" class="example_program"
>(cond
  ((equal? (quote b) (quote r)) (quote foo))
  (else (quote bar)))</div>

<div id="cond-test-2" class="example_program"
>(cond
  ((equal? (quote b) (quote r)) (quote foo))
  ((equal? (quote b) (quote b)) (quote blah))
  (else (quote bar)))</div>

<div id="lambda-test" class="example_program"
>(let*
  ((pair (lambda (x) (cons x (cons x ())))))
    (pair (quote (hi there))))</div>

<div id="pixley-interpreter" class="example_program"
>(lambda (program)
  (let* ((interpreter (lambda (interpret program env)
    (let*  ((cadr (lambda (alist)
              (car (cdr alist))))
            (null? (lambda (expr)
              (equal? expr (quote ()))))
            (find (lambda (self elem alist)
              (cond
                ((null? alist)
                  (quote nothing))
                (else
                  (let* ((entry (car alist))
                         (key   (car entry))
                         (rest  (cdr alist)))
                    (cond
                      ((equal? elem key)
                        entry)
                      (else
                        (self self elem rest))))))))
            (interpret-args (lambda (interpret-args args env)
              (cond
                ((null? args)
                  args)
                (else
                  (let* ((arg  (car args))
                         (rest (cdr args)))
                    (cons (interpret interpret arg env) (interpret-args interpret-args rest env)))))))
            (expand-args (lambda (expand-args formals argvals)
              (cond
                ((null? formals)
                  formals)
                (else
                  (let* ((formal       (car formals))
                         (rest-formals (cdr formals))
                         (argval       (car argvals))
                         (rest-argvals (cdr argvals)))
                    (cons (cons formal (cons argval (quote ()))) (expand-args expand-args rest-formals rest-argvals)))))))
            (concat-envs (lambda (concat-envs new-env old-env)
              (cond
                ((null? new-env)
                  old-env)
                (else
                  (let* ((entry (car new-env))
                         (rest  (cdr new-env)))
                    (cons entry (concat-envs concat-envs rest old-env)))))))
             (call-lambda (lambda (func args env)
               (let* ((arg-vals (interpret-args interpret-args args env)))
                  (func arg-vals)))))
      (cond
        ((null? program)
          program)
        ((list? program)
          (let* ((tag   (car program))
                 (args  (cdr program))
                 (entry (find find tag env)))
            (cond
              ((list? entry)
                (call-lambda (cadr entry) args env))
              ((equal? tag (quote lambda))
                (let* ((formals (car args))
                       (body    (cadr args)))
                  (lambda (arg-vals)
                    (let* ((arg-env   (expand-args expand-args formals arg-vals))
                           (new-env   (concat-envs concat-envs arg-env env)))
                      (interpret interpret body new-env)))))
              ((equal? tag (quote cond))
                (cond
                  ((null? args)
                    args)
                  (else
                    (let* ((branch   (car args))
                           (test     (car branch))
                           (expr     (cadr branch)))
                      (cond
                        ((equal? test (quote else))
                          (interpret interpret expr env))
                        ((interpret interpret test env)
                          (interpret interpret expr env))
                        (else
                          (let* ((branches (cdr args))
                                 (newprog (cons (quote cond) branches)))
                            (interpret interpret newprog env))))))))
              ((equal? tag (quote let*))
                (let* ((bindings (car args))
                       (body     (cadr args)))
                  (cond
                    ((null? bindings)
                      (interpret interpret body env))
                    (else
                      (let* ((binding  (car bindings))
                             (rest     (cdr bindings))
                             (ident    (car binding))
                             (expr     (cadr binding))
                             (value    (interpret interpret expr env))
                             (new-bi   (cons ident (cons value (quote ()))))
                             (new-env  (cons new-bi env))
                             (newprog  (cons (quote let*) (cons rest (cons body (quote ()))))))
                        (interpret interpret newprog new-env))))))
              ((equal? tag (quote list?))
                (list? (interpret interpret (car args) env)))
              ((equal? tag (quote quote))
                (car args))
              ((equal? tag (quote car))
                (car (interpret interpret (car args) env)))
              ((equal? tag (quote cdr))
                (cdr (interpret interpret (car args) env)))
              ((equal? tag (quote cons))
                (cons (interpret interpret (car args) env) (interpret interpret (cadr args) env)))
              ((equal? tag (quote equal?))
                (equal? (interpret interpret (car args) env) (interpret interpret (cadr args) env)))
              ((null? tag)
                tag)
              ((list? tag)
                (call-lambda (interpret interpret tag env) args env))
              (else
                (call-lambda tag args env)))))
        (else
          (let* ((entry (find find program env)))
            (cond
              ((list? entry)
                (cadr entry))
              (else
                (quote illegal-program-error))))))))))
      (interpreter interpreter program (quote ()))))</div>

</body>
<script src="../src/pixley.js"></script>
<script src="../src/yoob/source-manager.js"></script>
<script src="../src/yoob/preset-manager.js"></script>
<script src="../src/pixley-controller.js"></script>
<script src="../src/pixley-depictor.js"></script>
<script>
  var c = new PixleyController();
  c.init({
    'status': document.getElementById('status'),
    'display': document.getElementById('display'),
    'output': document.getElementById('output'),
    'wrapButton': document.getElementById('wrap')
  });
  document.getElementById('start').onclick = function() { c.start(); };
  document.getElementById('stop').onclick = function() { c.stop(); };
  c.depictor = new PixleyDepictor();
  c.depictor.init(document.getElementById('canvas'));

  var sourceManager = (new yoob.SourceManager()).init({
      'panelContainer': document.getElementById('edit_panel'),
      'editor': document.getElementById('program'),
      'hideDuringEdit': [document.getElementById('display')],
      'disableDuringEdit': [document.getElementById('panel')],
      //'storageKey': 'eg/controller.html',
      'onDone': function() {
          c.load(this.getEditorText());
      }
  });

  var presetManager = (new yoob.PresetManager()).init({
    selectElem: document.getElementById('select_source'),
    setPreset: function(id) {
      sourceManager.loadSourceFromHTML(document.getElementById(id).innerHTML);
    }
  }).populateFromClass('example_program').select('cons-test');
</script>
